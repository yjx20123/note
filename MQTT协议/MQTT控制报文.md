## 1：CONNECT- 连接服务端



客户端到服务端的网络连接建立后，客户端发送给服务端的第一个报文**必须**是connetct报文

在一个网络连接中，客户端只能发送一次connect报文。服务端必须将客户端发送的第二个connect报文当作协议违规处理并断开客户端的连接。  

有效载荷包含一个或多个编码的字段。包括客户端的唯一标识，Will主题，will消息，用户名和密码。除了客户端的标识之外，其他的字段都是可选的，基于标志位来决定可变报头中是否需要包含这些字段。

### 1.1固定报头（fixed header）

![image-20210425095459282](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210425095459282.png)

剩余长度字段

剩余长度等于可变报头的长度（10字节）加上有效载荷的长度

### 1.2可变报头（variable header)

connect报文的可变报头按下列次序包含了四个字段：协议名（protocol name),协议级别（protocol Level），连接标志（Connect Flags）和保持连接（keep alive)

#### 协议名 Protocol Name

##### 协议名字节构成

![image-20210425100044314](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210425100044314.png)

协议名是标识协议名MQTT的UTF-8编码的字符串，MQTT规范的后续版本不会改变这个字符串的偏移和长度。

如果协议名不正确**可以**断开客户端的连接，也**可以**按照某些其他规范继续处理CONNEDCT报文

> ###### 非规范评注
>
> 数据包检测工具，例如防火墙，可以使用协议名来识别MQTT流量

#### 协议级别 Protocol Level

##### Protocol Level byte协议级别字节构成

![image-20210425100847822](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210425100847822.png)

客户端用8位的无符号值标识协议的修订版本。对于3.1.1版协议，协议级别字段的值是4（0×04）。如果发现不支持的协议级别，服务端**必须** 发送一个返回码0x01(不支持的协议级别)的connect报文响应connect报文，然后断开客户端的连接

#### 连接标志 Connect Flags

连接标志字节包含一些指定MQTT连接行为的参数，它还指出有效载荷中的字段是否存在。

##### 连接标志位

![image-20210425101515619](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210425101515619.png)

服务端**必须** 验证connect控制报文的保留标志位（第0位）是否为0，如果不为0必须断开客户端连接

#### 清理回话 Clean Session

**位置**：连接标志字节的第一位

这个二进制位指定了会话状态的处理方式

客户端和服务端可以保存回话状态，以支持网络连接的可靠消息传输。这个标志位用于控制会话状态的生存时间。

如果清理回话（Clean Session）标志被设置为0，服务端**必须**基于当前会话（使用客户端标识符识别）的状态恢复与客户端的通信，如果没有与这个客户端标识符关联的会话，服务端**必须**创建一个新的会话，载连接断开之后，客户端和服务端**必须**保存回话消息。当清理回话标志为0是会话连接断开之后，服务端必须将之后的QoS 1

和Qos 2级别的消息保存为会话状态的一部分，如果这些消息匹配断开连接时客户端的任何订阅。服务端也可以保存满足相同条件的QoS 0级别的消息。

如果清理回话（Clean Session）标志被设置为1，客户端和服务端**必须**丢弃之前的任何会话并开始一个新的会话，会话仅支持和网络连接同样长的时间。与这个会话关联的状态数据**不能**被任何之后的会话重用。

